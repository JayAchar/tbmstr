---
title: "Study data quality"
author: "`r Sys.info()[['user']]`"
date: "`r Sys.time()`"
output: html_document
params:
  data: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, include = TRUE,
  message = FALSE
)
library(pointblank)
```

```{r define-agents}
al <- action_levels(
  stop_at = 1
)

baseline_agent <-
  create_agent(
    tbl = params$data,
    tbl_name = "baseline",
    label = "Baseline characteristics review",
    actions = al
  )

treatment_agent <-
  create_agent(
    tbl = params$data,
    tbl_name = "treatment",
    label = "Treatment review",
    actions = al
  )
```
## Baseline characteristics

```{r baseline-quality}
baseline_agent |>
  rows_distinct(
    columns = c("cntry", "stsite", "subjid"),
    label = "Distinct patient identifiers",
    brief = "Check the combination of country,
    site ID, and subject ID is unique"
  ) |>
  col_vals_between(
    columns = c("dob"),
    left = as.Date("1900-01-01"),
    right = as.Date("2022-01-01"),
    preconditions = function(x) {
      x$dob <- as.Date(x$dob, format = "%a %b %d %Y")
      x
    }
  ) |>
  col_vals_in_set(
    columns = "sex",
    set = c(1, 2)
  ) |>
  col_vals_between(
    columns = c("weight"),
    left = 0,
    right = 150,
    na_pass = FALSE
  ) |>
  col_vals_between(
    columns = c("height"),
    left = 1,
    right = 200,
    na_pass = FALSE
  ) |>
  col_vals_between(
    preconditions = function(x) {
      x$bmi <- x$weight / ((x$height / 100)^2)
      x
    },
    columns = c("bmi"),
    left = 0,
    right = 40
  ) |>
  col_vals_in_set(
    columns = c(
      "prison", "unempl", "smok",
      "alcohol", "homeless", "idu",
      "hiv", "liver"
    ),
    set = c(1, 2, 9)
  ) |>
  col_vals_in_set(
    columns = c("cav"),
    set = c(1, 2, 3, 9)
  ) |>
  col_vals_in_set(
    columns = c("prevtb"),
    set = c(1, 2, 9)
  ) |>
  col_vals_in_set(
    preconditions = function(x) {
      hep_type <- x$livertype[x$liver == 1]
      data.frame(livertype = hep_type)
    },
    columns = c("livertype"),
    set = c(1, 2, 3, 4)
  ) |>
  interrogate()
```
## Treatment

```{r treatment-quality}
treatment_agent |>
  col_vals_between(
    columns = c("totaldose"),
    left = 0,
    right = 400
  ) |>
  # TODO check that successful outcomes are restricted to people
  # who receive a limited number of doses
  col_vals_between(
    columns = c("outcome"),
    left = 1,
    right = 7,
    na_pass = FALSE
  ) |>
  col_vals_in_set(
    preconditions = function(x) {
      x[which(!is.na(x$outcome)), ]
    },
    columns = c("trtprtcl"),
    set = c(0, 1)
  ) |>
  col_vals_between(
    preconditions = function(x) {
      x[which(x$trtprtcl == 0), ]
    },
    columns = c("prtclviol"),
    left = 1,
    right = 10
  ) |>
  interrogate()
```

