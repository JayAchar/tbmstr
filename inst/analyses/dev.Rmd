---
title: "Analysis development"
author: "Jay Achar"
date: "`r Sys.time()`"
output: 
  - html_document
  - officedown::rdocx_document
params:
  tables: "Error" 
  plots: "Error" 
--- 

```{css css, echo=FALSE} 

summary { font-size: 2rem; font-weight: bold; }

h2 {
  font-size: 2rem;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flextable)
library(officedown)
library(officer)

# set gtsummary theme options
list("style_number-arg:big.mark" = "") %>%
  set_gtsummary_theme()

if (knitr::is_html_output()) {
  knitr::knit_hooks$set(
    wrap = function(before, options, envir) {
      if (before) {
        paste0("<details><summary>", options$wrap, "</summary>")
      } else {
        paste0("</details>")
      }
    }
  )
}

create_sum_text <- function(
    tab, var, levels, digits = 2,
    pattern = "{total} ({perc}%)") {
  meta <- tab[["meta_data"]]
  df <- meta$df_stats[which(meta$variable == var)][[1]]
  target_rows <- which(as.character(df$variable_levels) %in% levels)
  total <- sum(df$n[target_rows])
  denom <- unique(df$N)
  perc <- format(total / denom * 100, digits = digits)
  glue::glue(pattern)
}
```
## Methods

Baseline clinical and demographic characteristics, and treatment and study
outcomes were described for the treatment cohort. Treatment and study outcomes
were also described by baseline HIV status. The crude effects of baseline CD4
count and HIV treatment regimen were described in participants living with HIV.

Time to culture conversion was described for participants in whom baseline
sputum MGIT culture was positive. The cumulative incidence of culture conversion
was reported by 30 day increments until 120 days.

We described univariable assocations between baseline characteristics and
unfavourable study outcomes as crude hazard ratios, 95% confidence intervals and
p-values. Unsuccessful treatment outcomes and death or recurrence during
follow-up were defined as unsuccessful study outcomes. Participants who were
lost to post-treatment follow-up where censored. We then fitted a multivariable
Cox proportional hazard model with a random intercept to account for clustering
by study country. Characteristics with a p<0.1 were evaluated for inclusion.
Eligible characteristics were included in the multivariable model using a
forward stepwise appraoch. Since very few missing values were present in the 
data set, we used a complete case approach to handling missingness. The effects 
of imputing missing values on model estimates were explored through sensitivity 
analyses.

All statistical analyses were performed with R software (version 4.3.0).

\newpage

```{r wrap="Treatment cohort description", echo = FALSE}
create_text <- function(tab, pattern = "{n} ({p}%)") {
  function(var, level) {
    gtsummary::inline_text(
      tab,
      variable = dplyr::any_of(var),
      level = dplyr::any_of(level),
      pattern = pattern
    )
  }
}

text <- create_text(params$tables$tx_description)
inline <- create_text(params$tables$tx_description, "({n}, {p}%)")

htmltools::h2(
  "Baseline demographic and clinical characteristics of participants"
)
htmltools::hr()
autofit(params$tables$tx_description |>
  gtsummary::as_flex_table())
```
## Notes 

This section is complete. When copying the table into another document, ensure
to address the following style issues: 

* adjust the age-categories into a logical order, 
* the BMI label needs to have a superscript `2`,
* the country order should be alphabetical,
* need to add an explanation of abbreviations in the footnote,

**Need to add baseline MGIT culture status to table.**

## Manuscript text

After exclusion of (NUMBER) screening failures (Figure 1), 2636
participants from 13 countries were included in the treatment 
cohort. More than half of the participants were from Belarus `r inline("cntry", "Belarus")` or Ukraine
 `r inline("cntry", "Ukraine")`.

Baseline demographic and clinical characteriticss are described in Table XX.
The median age was XX years (IQR: ) with only `r text("age_grp", "<15")` 
participants under 15 years old and `r create_sum_text(params$tables$tx_description, "age_grp", c("<15", "15-24"))` under 24 years old. The large 
majority of participants were male `r text("sex", "Male")`. Small proportions of participants 
reported a history of injecting drug use `r text("idu", "Yes")`, 
homelessness `r text("homeless", "Yes")`, and 
excess alcohol use `r text("alcohol", "Yes")`. Approximately half reported a history of smoking 
`r inline("smok", "Yes")`. Evidence of HIV `r inline("hiv", "Yes")`, HCV 
 `r inline("hcvab", "Seropositive")` and SARS-CoV2 `r inline("covid", "Yes")` 
infection were present in a minority of participants. Baseline positive smear
microscopy `r inline("smear", "Positive")` and cavitatory changes on x-ray 
 `r create_sum_text(params$tables$tx_description, "cav", c("One-sided",
"Two-sided"), pattern = "({total}, {perc}%)")` were 
detected in over half of participants, while a majority (2136, 81%) had a 
positive baseline MGIT culture result.

\newpage

```{r wrap="Treatment cohort outcomes", echo = FALSE}
eot_text <- create_text(params$tables$tx_outcomes)
eot_inline <- create_text(params$tables$tx_outcomes, "({n}, {p}%)")

fail_text <- create_text(params$tables$failure_reasons)
fail_inline <- create_text(params$tables$failure_reasons, "({n}, {p}%)")

htmltools::h2(
  "End of treatment outcomes in treatment cohort"
)

params$tables$tx_outcomes |>
  gtsummary::as_flex_table()

htmltools::hr()

htmltools::h2(
  "Cumulative probability of TB-free status at specified timepoints",
  "after treatment initiation"
)

params$tables$fail_survival

htmltools::hr()

htmltools::h2(
  "Reasons for treatment failure"
)

params$tables$failure_reasons |>
  gtsummary::as_flex_table()


htmltools::hr()

params$tables$who_fu_outcomes |>
  gtsummary::as_flex_table()

params$plots$p1

params$plots$p2
```

## Notes 

This section is can be improved. The end of treatment descriptive table is final. 
However, the description of follow-up requires some review. The outstanding
questions are below:

*  Which time points to choose? At this stage I've chosen 301 days to give an 
   accurate description of the end of treatment outcomes. Around 45 participants
   who extended their treatment were given failure outcomes well after 9 months 
   of treatment. They have had their follow-up time manually censored at 300
   days - resulting in the step that's visible in the time to failure graph. 

* Notice how the cumulative probability of TB-free status remains much higher 
  than the `naive` estimate provided in the final table in this section. 

**Remove unused levels from the `Reasons for failure` table**

## Manuscript text

At the end of treatment, `r create_sum_text(params$tables$tx_outcomes, "outcome",
c("Cured", "Completed"))` participants were successfully treated and `r eot_text("outcome", "Died")`
died. Amongst  `r eot_text("outcome", "Failed")` failed treatment 
episodes, the most frequently reported reasons were adverse events requiring a
treatment change 
`r fail_inline("failure_reasons", "Adverse drug reaction resulting in treatment change")` 
and clinician-driven treatment extensions 
`r fail_inline("failure_reasons", "Treatment extended by clinician")`,  
not receiving sufficient treatment during the treatment duration 
`r fail_inline("failure_reasons", "Insufficient treatment received in accepted time")`
(Supplementery table xx)


<!---BLOCK_LANDSCAPE_START--->

```{r wrap="Predictors of unsuccessful outcome", echo = FALSE}
htmltools::h2(
  "Crude and adjusted analysis of independent predictors of unsuccessful study outcome"
)
htmltools::hr()
autofit(params$tables$tx_mv_failure)
```
<!---BLOCK_LANDSCAPE_STOP--->

```{r wrap="Treatment outcomes by HIV status", echo = FALSE}
htmltools::h2(
  "Description of end of treatment and end of study outcomes for all participants by baseline HIV status"
)
htmltools::hr()
params$tables$hiv$outcome_by_status |>
  gtsummary::as_flex_table()

params$plots$p3
```

\newpage

```{r wrap="Baseline HIV treatment and CD4 count description", echo = FALSE}
htmltools::h2(
  "Description of baseline CD4 count and HIV treatment regimens in participants living with HIV"
)
htmltools::hr()
params$tables$hiv$hiv_outcomes |>
  gtsummary::as_flex_table()

params$plots$p4

params$plots$p5
```

\newpage


```{r wrap="Treatment follow-up in PLHIV", echo = FALSE}
htmltools::h2(
  "Treatment follow-up in PLHIV"
)
htmltools::hr()
params$tables$hiv$follow_up |>
  gtsummary::as_flex_table()
```

<!---BLOCK_LANDSCAPE_START--->

```{r wrap="Failure & Death by HIV-specific factors", echo = FALSE}
htmltools::h2(
  "Crude associations between baseline HIV treatment and CD4 count and time to unsuccessful outcome and time to death"
)
htmltools::hr()
params$tables$hiv$failure_death |>
  gtsummary::as_flex_table()
```

<!---BLOCK_LANDSCAPE_STOP--->

```{r wrap="Culture conversion risk", echo = FALSE}
htmltools::h2(
  "Cumulative incidence of culture conversion by monthly time-points"
)
htmltools::hr()
params$tables$cc_risk

params$plots$conversion
```

\newpage

```{r wrap="Outcomes after 12 months follow-up", echo = FALSE}
htmltools::h2(
  "Treatment and study oucomes in participants with 12 months follow-up"
)
htmltools::hr()
params$tables$full_fu
```
\newpage

```{r wrap="Probability of study success during follow-up", echo = FALSE}
htmltools::h2(
  "Overall probability of successful study outcome during treatment follow-up"
)
htmltools::hr()
params$plots$fu_survival
params$tables$fu_survival
```
\newpage

```{r wrap="Description of deaths", echo = FALSE}
htmltools::h2(
  "Study team descriptions of cause of death"
)
htmltools::hr()
params$tables$death_description
```

